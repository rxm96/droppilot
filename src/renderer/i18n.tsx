import { createContext, useContext, useMemo } from "react";
import type { ReactNode } from "react";

export type Language = "de" | "en";

type Translations = Record<Language, Record<string, string>>;

const translations: Translations = {
  en: {
    "app.name": "DropPilot",
    "hero.title": "Control Hub",
    "hero.accountLinked": "Account linked",
    "hero.accountNotLinked": "Account not linked",
    "hero.activeCampaign": "Active campaign",
    "hero.noTarget": "No target",
    "hero.nextPing": "Next update in {time}",
    "hero.pingError": "Update error",
    "hero.drops": "Drops",
    "hero.targetProgress": "Target progress",
    "hero.account": "Account",
    "hero.profileLoading": "Loading profile...",
    "hero.profileIdle": "Not logged in",
    "hero.demoMode": "Demo mode",

    "nav.overview": "Overview",
    "nav.overview.caption": "Status & Profile",
    "nav.inventory": "Inventory",
    "nav.inventory.caption": "Drops & Progress",
    "nav.control": "Control",
    "nav.control.caption": "Watching & Auto-Switch",
    "nav.debug": "Debug",
    "nav.debug.caption": "Live logs & state",
    "nav.settings": "Settings",
    "nav.settings.caption": "Priority & Export",

    "session.title": "Session",
    "session.connected": "Twitch linked",
    "session.disconnected": "Not linked",
    "session.loggingIn": "Login in progress...",
    "session.ready": "Ready to watch & claim",
    "session.loginNeeded": "Please log in to collect drops",
    "session.linkedChip": "Linked",
    "session.offlineChip": "Offline",
    "session.loginBrowser": "Login with browser",
    "session.loginCredentials": "Login with credentials",
    "session.logout": "Logout",
    "session.login": "Login...",
    "session.credentials": "Credentials (optional)",
    "session.username": "Username",
    "session.password": "Password",
    "session.token": "2FA / Email Code",

    "nav.title": "Navigation",

    "settings.title": "Settings",
    "settings.quickActions": "Quick actions",
    "settings.priorityLabel": "Priority Games",
    "settings.addFromDrops": "Select from active drops",
    "settings.none": "No entries yet.",
    "settings.obeyPriority": "Follow priority list",
    "settings.backup": "Backup / Import",
    "settings.sessionActions": "Session",
    "settings.language": "Language",
    "settings.language.de": "German",
    "settings.language.en": "English",

    "inventory.title": "Inventory",
    "inventory.filterHint": "Filters: Not linked, Upcoming, Expired, Excluded, Finished.",
    "inventory.refreshing": "Refreshing...",
    "inventory.filter.all": "All",
    "inventory.filter.active": "Active",
    "inventory.filter.upcoming": "Upcoming",
    "inventory.filter.finished": "Finished",
    "inventory.filter.notLinked": "Not linked",
    "inventory.filter.expired": "Expired",
    "inventory.filter.excluded": "Excluded",
    "inventory.allGames": "All games",
    "inventory.loading": "Inventory loading...",
    "inventory.error": "Inventory error",
    "inventory.idle": "Not loaded yet",
    "inventory.empty": "No drops for this filter.",
    "inventory.minutes": "min",
    "inventory.page": "Page {current} / {total}",
    "inventory.prev": "< Prev",
    "inventory.next": "Next >",
    "inventory.range.none": "No timeframe",
    "inventory.range.starts": "Starts: {date}",
    "inventory.range.ends": "Ends: {date}",
    "inventory.status.claimed": "Claimed",
    "inventory.status.progress": "In progress",
    "inventory.status.locked": "Locked",
    "inventory.category.inProgress": "Active",
    "inventory.category.upcoming": "Upcoming",
    "inventory.category.finished": "Finished",
    "inventory.category.notLinked": "Not linked",
    "inventory.category.expired": "Expired",
    "inventory.category.excluded": "Excluded",

    "titlebar.tray": "Minimize to tray",
    "titlebar.minimize": "Minimize",
    "titlebar.maximize": "Maximize",
    "titlebar.close": "Close",
    "titlebar.updateAvailable": "Update available",
    "titlebar.updateDownloading": "Downloading update",
    "titlebar.updateReady": "Update ready",

    "control.title": "Control",
    "control.subtitle": "Active watching and campaign progress.",
    "control.pingError": "Ping error",
    "control.autoClaim": "Auto-claim",
    "control.activeStream": "Active stream",
    "control.stop": "Stop",
    "control.noChannel": "No channel selected yet.",
    "control.pickStream": "Pick a stream below to start.",
    "control.noDropsHint": "No active drops for this game. Choose a different target.",
    "control.progress": "Progress",
    "control.refresh": "Refresh progress",
    "control.gameLabel": "Game",
    "control.dropsLabel": "Drops",
    "control.minutesLabel": "Minutes",
    "control.progressLabel": "Progress",
    "control.activeDrop": "Active drop",
    "control.currentDrop": "Current drop",
    "control.done": "Completed",
    "control.eta": "ETA {time}",
    "control.rest": "Remaining: {time}",
    "control.allDone": "All drops for this game collected.",
    "control.targetMissing": "No target game selected.",
    "control.targetTitle": "Target game",
    "control.noTarget": "No target",
    "control.reset": "Reset",
    "control.activeTarget": "Active target",
    "control.streamsFound": "Streams found",
    "control.dropsOpen": "Open drops",
    "control.channelsLoading": "Updating channels...",
    "control.channelError": "Channel error",
    "control.channelsEmpty": "No channels available.",
    "control.viewers": "Viewers",
    "control.live": "Watching",

    "debug.title": "Debug",
    "debug.subtitle": "Live event log and current state snapshot.",
    "debug.snapshot": "State snapshot",
    "debug.log": "Event log",
    "debug.search": "Search logs...",
    "debug.clear": "Clear",
    "debug.pause": "Pause",
    "debug.resume": "Resume",
    "debug.autoScroll": "Auto-scroll",
    "debug.copy": "Copy snapshot",
    "debug.copied": "Copied",
    "debug.loading": "Loading debug view...",
    "debug.total": "Total",
    "debug.details": "Details",
    "debug.empty": "No logs yet.",
    "debug.emptyMessage": "No message",
    "debug.status.live": "Live",
    "debug.status.paused": "Paused",
    "debug.status.autoScrollOn": "Auto-scroll: on",
    "debug.status.autoScrollOff": "Auto-scroll: off",

    "overview.title": "Overview",
    "overview.subtitle": "Quick look at stats and connection.",
    "overview.stats": "Stats",
    "overview.reset": "Reset",
    "overview.totalMinutes": "Total minutes",
    "overview.claims": "Claims",
    "overview.lastClaim": "Last claim",
    "overview.lastGame": "Last",
    "overview.loading": "Loading stats...",
    "overview.error": "Stats error",
    "overview.empty": "No stats loaded.",
    "overview.connection": "Twitch connection",
    "overview.logout": "Logout",
    "overview.profileMissing": "No profile loaded.",
    "overview.dropsTotal": "Total drops",
    "overview.dropsActive": "Active",
    "overview.linked": "Linked",
    "overview.notLinked": "Not linked",

    "settings.session": "Session",
    "settings.priorityGames": "Priority Games",
    "settings.addFromDropsOption": "Select from active drops",
    "settings.addGamePlaceholder": "Game name (e.g. Escape from Tarkov: Arena)",
    "settings.add": "Add",
    "settings.noneEntries": "No entries yet.",
    "settings.drag": "Drag",
    "settings.remove": "Remove",
    "settings.obey": "Follow priority list",
    "settings.backupTitle": "Backup / Import",
    "settings.backupHint": "Save or import settings as JSON.",
    "settings.export": "Export",
    "settings.import": "Import",
    "settings.languageLabel": "Language",
    "settings.updates": "Updates",
    "settings.checkUpdates": "Check for updates",
    "settings.updateDownload": "Download update",
    "settings.updateInstall": "Install update",
    "settings.updateChecking": "Checking for updates...",
    "settings.updateAvailable": "Update available ({version}).",
    "settings.updateDownloading": "Downloading {percent}% ({transferred}/{total})",
    "settings.updateDownloaded": "Update downloaded. Restart to install.",
    "settings.updateNone": "You're up to date.",
    "settings.updateError": "Update check failed",
    "settings.updateUnsupported": "Updates are only available in the installed Windows app.",
    "settings.advanced": "Automation",
    "settings.advancedHint": "Control auto-claim, auto-select, auto-switch & refresh cadence.",
    "settings.autoClaim": "Auto-claim drops",
    "settings.autoSelect": "Auto-select first channel",
    "settings.autoSwitch": "Auto-switch when channel disappears",
    "settings.demoModeTitle": "Demo mode",
    "settings.demoMode": "Demo mode",
    "settings.demoModeHint": "Use demo data to explore the app without active drops.",
    "settings.refreshInterval": "Inventory refresh interval",
    "settings.refreshHint": "Bounds for periodic inventory refresh (seconds, min 60s).",
    "settings.resetAutomation": "Reset automation to defaults",
    "settings.alerts": "Alerts",
    "settings.alertsHint": "Desktop notifications for key events.",
    "settings.alerts.enabled": "Enable smart alerts",
    "settings.alerts.foreground": "Notify even when app is focused",
    "settings.alerts.dropClaimed": "Notify on auto-claim",
    "settings.alerts.dropEnding": "Notify before drop ends",
    "settings.alerts.dropEndingMinutes": "Minutes before end",
    "settings.alerts.watchError": "Notify on watch errors",
    "settings.alerts.autoSwitch": "Notify on auto-switch",
    "settings.alerts.newDrops": "Notify on new drops",
    "settings.alerts.test": "Send test notification",
    "alerts.title.dropClaimed": "Drop claimed",
    "alerts.body.dropClaimed": "{title} ({game})",
    "alerts.title.dropEndingSoon": "Drop ending soon",
    "alerts.body.dropEndingSoon": "{title} in {minutes} min",
    "alerts.title.watchError": "Watch ping error",
    "alerts.body.watchError": "{message}",
    "alerts.title.autoSwitch": "Auto-switched channel",
    "alerts.body.autoSwitch": "{from} -> {to}",
    "alerts.title.newDrops": "New drops available",
    "alerts.body.newDrops": "{count} new drops for {games}",
    "alerts.title.test": "Test notification",
    "alerts.body.test": "This is a test from DropPilot.",
    "alerts.misc.multipleGames": "multiple games",
    "alerts.misc.unknownChannel": "Unknown channel",
    "error.unknown": "Unexpected error",
    "error.gql.failed": "Twitch API error",
    "error.spade.fetch_failed": "Failed to load stream page",
    "error.spade.url_missing": "Watch tracking endpoint not found",
    "error.watch.missing_login": "Missing channel login",
    "error.watch.offline": "Stream is offline",
    "error.watch.missing_ids": "Missing stream identifiers",
    "error.watch.ping_failed": "Watch ping failed",
    "error.game.slug_missing": "Game slug not found",
    "error.inventory.empty": "No drops found",
    "error.claim.missing_id": "Claim ID missing",
    "error.claim.failed": "Claim failed",
    "error.profile.fetch_failed": "Profile fetch failed",
  },
  de: {
    "app.name": "DropPilot",
    "hero.title": "Control Hub",
    "hero.accountLinked": "Account verknüpft",
    "hero.accountNotLinked": "Account nicht verknüpft",
    "hero.activeCampaign": "Aktive Kampagne",
    "hero.noTarget": "Kein Ziel",
    "hero.nextPing": "Nächste Aktualisierung in {time}",
    "hero.pingError": "Aktualisierungsfehler",
    "hero.drops": "Drops",
    "hero.targetProgress": "Ziel-Progress",
    "hero.account": "Account",
    "hero.profileLoading": "Lade Profil...",
    "hero.profileIdle": "Nicht eingeloggt",
    "hero.demoMode": "Demo-Modus",

    "nav.overview": "Overview",
    "nav.overview.caption": "Status & Profil",
    "nav.inventory": "Inventory",
    "nav.inventory.caption": "Drops & Fortschritt",
    "nav.control": "Control",
    "nav.control.caption": "Watching & Auto-Switch",
    "nav.debug": "Debug",
    "nav.debug.caption": "Live-Logs & Status",
    "nav.settings": "Settings",
    "nav.settings.caption": "Prioritäten & Export",

    "session.title": "Session",
    "session.connected": "Twitch verbunden",
    "session.disconnected": "Nicht verbunden",
    "session.loggingIn": "Login läuft...",
    "session.ready": "Bereit zum Schauen & Claim",
    "session.loginNeeded": "Bitte einloggen, um Drops zu sammeln",
    "session.linkedChip": "Linked",
    "session.offlineChip": "Offline",
    "session.loginBrowser": "Login mit Browser",
    "session.loginCredentials": "Login per Credentials",
    "session.logout": "Logout",
    "session.login": "Login...",
    "session.credentials": "Credentials (optional)",
    "session.username": "Username",
    "session.password": "Password",
    "session.token": "2FA / Email Code",

    "nav.title": "Navigation",

    "settings.title": "Settings",
    "settings.quickActions": "Schnelle Aktionen",
    "settings.priorityLabel": "Priority Games",
    "settings.addFromDrops": "Aus aktiven Drops wählen",
    "settings.none": "Noch keine Einträge.",
    "settings.obeyPriority": "Prioritätenliste befolgen",
    "settings.backup": "Backup / Import",
    "settings.sessionActions": "Session",
    "settings.language": "Sprache",
    "settings.language.de": "Deutsch",
    "settings.language.en": "Englisch",

    "inventory.title": "Inventory",
    "inventory.filterHint": "Filter: Not linked, Upcoming, Expired, Excluded, Finished.",
    "inventory.refreshing": "Aktualisiere...",
    "inventory.filter.all": "Alle",
    "inventory.filter.active": "Aktiv",
    "inventory.filter.upcoming": "Bevorstehend",
    "inventory.filter.finished": "Abgeschlossen",
    "inventory.filter.notLinked": "Nicht verknüpft",
    "inventory.filter.expired": "Abgelaufen",
    "inventory.filter.excluded": "Ausgeschlossen",
    "inventory.allGames": "Alle Games",
    "inventory.loading": "Inventory wird geladen...",
    "inventory.error": "Inventory-Fehler",
    "inventory.idle": "Noch nicht geladen",
    "inventory.empty": "Keine Drops für diesen Filter.",
    "inventory.minutes": "Minuten",
    "inventory.page": "Seite {current} / {total}",
    "inventory.prev": "< Zurück",
    "inventory.next": "Weiter >",
    "inventory.range.none": "Kein Zeitraum",
    "inventory.range.starts": "Start: {date}",
    "inventory.range.ends": "Ende: {date}",
    "inventory.status.claimed": "Eingelöst",
    "inventory.status.progress": "In Progress",
    "inventory.status.locked": "Gesperrt",
    "inventory.category.inProgress": "Aktiv",
    "inventory.category.upcoming": "Bevorstehend",
    "inventory.category.finished": "Abgeschlossen",
    "inventory.category.notLinked": "Nicht verknüpft",
    "inventory.category.expired": "Abgelaufen",
    "inventory.category.excluded": "Ausgeschlossen",

    "titlebar.tray": "In Tray minimieren",
    "titlebar.minimize": "Minimieren",
    "titlebar.maximize": "Maximieren",
    "titlebar.close": "Schließen",
    "titlebar.updateAvailable": "Update verfuegbar",
    "titlebar.updateDownloading": "Update laedt",
    "titlebar.updateReady": "Update bereit",

    "control.title": "Control",
    "control.subtitle": "Aktives Watching und Kampagnen-Progress.",
    "control.pingError": "Ping-Fehler",
    "control.autoClaim": "Auto-Claim",
    "control.activeStream": "Aktiver Stream",
    "control.stop": "Stop",
    "control.noChannel": "Noch kein Channel ausgewählt.",
    "control.pickStream": "Wähle unten einen Stream aus, um zu starten.",
    "control.noDropsHint": "Keine aktiven Drops für dieses Game. Wähle ein anderes Ziel.",
    "control.progress": "Fortschritt",
    "control.refresh": "Fortschritt aktualisieren",
    "control.gameLabel": "Game",
    "control.dropsLabel": "Drops",
    "control.minutesLabel": "Minuten",
    "control.progressLabel": "Progress",
    "control.activeDrop": "Aktiver Drop",
    "control.currentDrop": "Aktueller Drop",
    "control.done": "Abgeschlossen",
    "control.eta": "ETA {time}",
    "control.rest": "Rest: {time}",
    "control.allDone": "Alle Drops für dieses Game abgeholt.",
    "control.targetMissing": "Kein Ziel-Game gewählt.",
    "control.targetTitle": "Ziel-Game",
    "control.noTarget": "Kein Ziel",
    "control.reset": "Reset",
    "control.activeTarget": "Aktives Ziel",
    "control.streamsFound": "Streams gefunden",
    "control.dropsOpen": "Drops offen",
    "control.channelsLoading": "Aktualisiere Channels...",
    "control.channelError": "Channel-Fehler",
    "control.channelsEmpty": "Keine Channels verfügbar.",
    "control.viewers": "Zuschauer",
    "control.live": "Watching",

    "debug.title": "Debug",
    "debug.subtitle": "Live-Log und aktueller Status-Snapshot.",
    "debug.snapshot": "Status-Snapshot",
    "debug.log": "Event-Log",
    "debug.search": "Logs durchsuchen...",
    "debug.clear": "Leeren",
    "debug.pause": "Pausieren",
    "debug.resume": "Fortsetzen",
    "debug.autoScroll": "Auto-Scroll",
    "debug.copy": "Snapshot kopieren",
    "debug.copied": "Kopiert",
    "debug.loading": "Debug-Ansicht wird geladen...",
    "debug.total": "Gesamt",
    "debug.details": "Details",
    "debug.empty": "Noch keine Logs.",
    "debug.emptyMessage": "Keine Nachricht",
    "debug.status.live": "Live",
    "debug.status.paused": "Pausiert",
    "debug.status.autoScrollOn": "Auto-Scroll: an",
    "debug.status.autoScrollOff": "Auto-Scroll: aus",

    "overview.title": "Overview",
    "overview.subtitle": "Schneller Blick auf Stats und Verbindung.",
    "overview.stats": "Stats",
    "overview.reset": "Reset",
    "overview.totalMinutes": "Ges. Minuten",
    "overview.claims": "Claims",
    "overview.lastClaim": "Letzter Claim",
    "overview.lastGame": "Zuletzt",
    "overview.loading": "Lade Stats...",
    "overview.error": "Stats-Fehler",
    "overview.empty": "Keine Stats geladen.",
    "overview.connection": "Twitch Verbindung",
    "overview.logout": "Logout",
    "overview.profileMissing": "Kein Profil geladen.",
    "overview.dropsTotal": "Drops gesamt",
    "overview.dropsActive": "Aktiv",
    "overview.linked": "Linked",
    "overview.notLinked": "Not linked",

    "settings.session": "Session",
    "settings.priorityGames": "Priority Games",
    "settings.addFromDropsOption": "Aus aktiven Drops wählen",
    "settings.addGamePlaceholder": "Game name (z.B. Escape from Tarkov: Arena)",
    "settings.add": "Hinzufügen",
    "settings.noneEntries": "Noch keine Einträge.",
    "settings.drag": "Ziehen",
    "settings.remove": "Entfernen",
    "settings.obey": "Prioritätenliste befolgen",
    "settings.backupTitle": "Backup / Import",
    "settings.backupHint": "Einstellungen als JSON sichern oder einspielen.",
    "settings.export": "Exportieren",
    "settings.import": "Importieren",
    "settings.languageLabel": "Sprache",
    "settings.updates": "Updates",
    "settings.checkUpdates": "Nach Updates suchen",
    "settings.updateDownload": "Update herunterladen",
    "settings.updateInstall": "Jetzt installieren",
    "settings.updateChecking": "Suche nach Updates...",
    "settings.updateAvailable": "Update verfügbar ({version}).",
    "settings.updateDownloading": "Download {percent}% ({transferred}/{total})",
    "settings.updateDownloaded": "Update geladen. Zum Installieren neu starten.",
    "settings.updateNone": "Du bist aktuell.",
    "settings.updateError": "Update-Check fehlgeschlagen",
    "settings.updateUnsupported": "Updates sind nur in der installierten Windows-App verfügbar.",
    "settings.advanced": "Automatisierung",
    "settings.advancedHint": "Steuert Auto-Claim, Auto-Select, Auto-Switch & Refresh-Takt.",
    "settings.autoClaim": "Auto-Claim aktiv",
    "settings.autoSelect": "Auto-Select ersten Channel",
    "settings.autoSwitch": "Auto-Switch wenn Channel weg ist",
    "settings.demoModeTitle": "Demo-Modus",
    "settings.demoMode": "Demo-Modus",
    "settings.demoModeHint": "Demo-Daten nutzen, um die App ohne aktive Drops zu erkunden.",
    "settings.refreshInterval": "Inventory Refresh Intervall",
    "settings.refreshHint": "Grenzen für periodischen Inventory-Refresh (Sekunden, min 60s).",
    "settings.resetAutomation": "Automation auf Standard zurücksetzen",
    "settings.alerts": "Benachrichtigungen",
    "settings.alertsHint": "Desktop-Alerts für wichtige Events.",
    "settings.alerts.enabled": "Smart Alerts aktivieren",
    "settings.alerts.foreground": "Auch bei aktivem Fenster benachrichtigen",
    "settings.alerts.dropClaimed": "Benachrichtigen bei Auto-Claim",
    "settings.alerts.dropEnding": "Benachrichtigen vor Drop-Ende",
    "settings.alerts.dropEndingMinutes": "Minuten vor Ende",
    "settings.alerts.watchError": "Benachrichtigen bei Watch-Fehlern",
    "settings.alerts.autoSwitch": "Benachrichtigen bei Auto-Switch",
    "settings.alerts.newDrops": "Benachrichtigen bei neuen Drops",
    "settings.alerts.test": "Testbenachrichtigung senden",
    "alerts.title.dropClaimed": "Drop eingesammelt",
    "alerts.body.dropClaimed": "{title} ({game})",
    "alerts.title.dropEndingSoon": "Drop endet bald",
    "alerts.body.dropEndingSoon": "{title} in {minutes} Min",
    "alerts.title.watchError": "Watch-Ping Fehler",
    "alerts.body.watchError": "{message}",
    "alerts.title.autoSwitch": "Channel gewechselt",
    "alerts.body.autoSwitch": "{from} -> {to}",
    "alerts.title.newDrops": "Neue Drops verfügbar",
    "alerts.body.newDrops": "{count} neue Drops für {games}",
    "alerts.title.test": "Testbenachrichtigung",
    "alerts.body.test": "Das ist ein Test von DropPilot.",
    "alerts.misc.multipleGames": "mehrere Games",
    "alerts.misc.unknownChannel": "Unbekannter Channel",
    "error.unknown": "Unerwarteter Fehler",
    "error.gql.failed": "Twitch-API-Fehler",
    "error.spade.fetch_failed": "Streamer-Seite konnte nicht geladen werden",
    "error.spade.url_missing": "Watch-Tracking-Endpunkt nicht gefunden",
    "error.watch.missing_login": "Channel-Login fehlt",
    "error.watch.offline": "Stream ist offline",
    "error.watch.missing_ids": "Stream-IDs fehlen",
    "error.watch.ping_failed": "Watch-Ping fehlgeschlagen",
    "error.game.slug_missing": "Game-Slug nicht gefunden",
    "error.inventory.empty": "Keine Drops gefunden",
    "error.claim.missing_id": "Claim-ID fehlt",
    "error.claim.failed": "Claim fehlgeschlagen",
    "error.profile.fetch_failed": "Profil konnte nicht geladen werden",
  },
};

type I18nContextValue = {
  language: Language;
  t: (key: string, vars?: Record<string, string | number>) => string;
};

const I18nContext = createContext<I18nContextValue>({
  language: "en",
  t: (key) => key,
});

function format(str: string, vars?: Record<string, string | number>) {
  if (!vars) return str;
  return str.replace(/\{(\w+)\}/g, (_m, k) => (k in vars ? String(vars[k]) : _m));
}

export function translate(language: Language, key: string, vars?: Record<string, string | number>) {
  const langTable = translations[language] ?? translations.de;
  const fallback = translations.en;
  const str = langTable[key] ?? fallback[key] ?? key;
  return format(str, vars);
}

export function I18nProvider({ language, children }: { language: Language; children: ReactNode }) {
  const t = useMemo(() => {
    return (key: string, vars?: Record<string, string | number>) => {
      const langTable = translations[language] ?? translations.de;
      const fallback = translations.en;
      const str = langTable[key] ?? fallback[key] ?? key;
      return format(str, vars);
    };
  }, [language]);

  return <I18nContext.Provider value={{ language, t }}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  return useContext(I18nContext);
}
